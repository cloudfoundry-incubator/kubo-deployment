# Kubo deployment

This repository contains automation scripts to deploy a [Kubernetes](https://kubernetes.io/) cluster using 
[BOSH](https://bosh.io/) within a [CloudFoundry](https://cloudfoundry.org) infrastructure.

## Glossary

- Kubo - Kubernetes on BOSH
- BOSH++ - BOSH with UAA, Credhub and PowerDNS
- BOSH Configuration - Folder that contains all configuration files needed to deploy BOSH++, as well as all 
configuration files that are generated while deploying BOSH++. Also called `<BOSH_ENV>`
- Environment Configuration and Environment Secrets - Configuration files that are used to deploy Kubo, these
are stored in `<BOSH_ENV>/director.yml` and `<BOSH_ENV>/director-secrets.yml`, respectively. Environment secrets 
are sensitive and should not be checked into a repository.
- Creds - Credentials that are generated by the BOSH++ deployment process and stored in `<BOSH_ENV>/creds.yml`
- Service - We will use the following terms to distinguish between different uses of the word "service"
  - [Service Instance](https://docs.cloudfoundry.org/devguide/services) - Cloud foundry services, which allow 
    provisioning of resources within a Cloud Foundry installation
  - [K8s service](https://kubernetes.io/docs/user-guide/services) - A logical collection of Kubernetes pods and
    a way to access them without needing information about the specific pods

# Required software

You'll need the following tools on your machine to continue:

- [bosh-cli](https://bosh.io/docs/cli-v2.html) for interacting with BOSH. Version 2.0.1 and above.
- [credhub cli](https://github.com/pivotal-cf/credhub-cli) for interacting with CredHub. Version 0.4 only.

# Deploy

The scripts require custom environment configuration before the deployment can take place. 

## Environment preparation

The environment preparation is out of scope. Check [here](https://bosh.io/docs/init.html) for more documentation.

## Cloud Foundry

Cloud Foundry deployment is not covered in this document.

TCP router and the Routing API should be enabled on the Cloud Foundry installation. See [OSS CF](https://docs.cloudfoundry.org/adminguide/enabling-tcp-routing.html) or
[PCF](http://docs.pivotal.io/pivotalcf/1-8/opsguide/tcp-routing-ert-config.html) documentation for 
further details.

A UAA client with [appropriate authorities](https://github.com/cloudfoundry-incubator/routing-api#configure-oauth-clients-manually-using-uaac-cli-for-uaa)
is required in order to register the TCP routes.

## Generate configuration

The configuration can be generated using `bin/generate_env_config`.
It requires a path to a directory where the configuration will be stored, the name of the environment,
and the IaaS name.

It will create a directory with the same name as the environment at the specified path, containing three files: 
- `iaas` which contains IaaS name
- `director.yml` which contains public BOSH director, IaaS and network configurations 
- `director-secrets.yml` which contains secrets, such as OpenStack password

## Fill in configuration

The format for all configuration files is YAML. The main configuration is stored in a `director.yml` file. All 
the properties have comments explaining their possible values and their purpose.

## Deploy BOSH++

### What is BOSH++? 

BOSH with integrated PowerDNS and CredHub. It is used to auto-generate certificates for kubelets. 
You can generate certificate for kubelets manually and use them as part of deployment. In that case you can use 
regular BOSH.

### Deployment process

When the environment preparation and configuration is completed, `BOSH++` can be
easily deployed with a single command:

```bash
bin/deploy_bosh <path to configuration>
```

During the deployment, all the passwords and SSL certificates will be automatically
generated. Most of them will be saved into the configuration path in a file called 
`creds.yml`. Because this file will contain sensitive information, it is not recommended
to store it in a VCS. This file is also required to successfully deploy the kubernetes
service or the on-demand broker.
 
Subsequent runs of `bin/bosh_deploy` will apply changes made to the configuration
to an already existing BOSH++ installation, reusing the credentials stored in the `creds.yml`.

Another file that gets created during initial deployment is called `state.json`. It contains
the BOSH state identical to the one used by [bosh-init](https://bosh.io/docs/using-bosh-init.html).

Additionally, the deployment script creates the `default` CA certificate within CredHub.

## Deploy Kubo

### The Easy Way: Automated 

Once BOSH++ is deployed, the Kubernetes BOSH release can be built and deployed with this command:

```bash
bin/deploy_k8s <BOSH_ENV> <DEPLOYMENT_NAME> <RELEASE_SOURCE>
```

The `RELEASE_SOURCE` parameter allows you to either build and deploy a local copy of the repository, or deploy our pre-built kubo-release tarball, and is optional.

Note that the scripts will:

- Generate certificate in CredHub
- upload any Cloud Config changes to the director
- create the kubo release from source and upload it if RELEASE_SOURCE is dev
or 
- upload the kubo release tarball from specified location if RELEASE_SOURCE is local
- regenerate the deployment manifest
- kick off the deployment using `bosh_admin` UAA client

By default, the deployment will use the latest versions of the releases. If releases were uploaded from different machines or 
used different sources, deployment might use wrong release.

### The Hard Way: Step by Step 

#### Generate Cloud Config

Kubo deployment uses [BOSH 2.0 Cloud Config](https://bosh.io/docs/cloud-config.html).

The default cloud config for GCP uses n1-standard-1 VMs for supporting services and n1-standard-2 VMs
for Kubernetes workers. The network properties are pulled in from the environment configuration file 
which is stored at `<BOSH_ENV>/director.yml`.

Cloud config can be generated using following command:
```bash
bin/generate_cloud_config <BOSH_ENV>
```

##### Create and upload release

To create dev release, download the [kubo-release repository](https://github.com/pivotal-cf-experimental/kubo-release) 
and follow [documentation](https://bosh.io/docs/create-release.html#dev-release)

##### Generate manifest

Manifest can be generated using command `bin/generate_service_manifest <BOSH_ENV> <DEPLOYMENT_NAME>`

##### Deploy

Run deployment using the following command: `bosh-cli -e <BOSH_ALIAS> -d <DEPLOYMENT_NAME> deploy <PATH to MANIFEST>`
where `<BOSH_ALIAS>` is BOSH director name from configuration file or BOSH director address

`bosh-cli` has to be authenticated to BOSH director

## Accessing Kubo

Configure kubectl for your Kubo instance with the following command: 

```bash
bin/set_kubeconfig <BOSH_ENV> <DEPLOYMENT_NAME>
```

You can now issue kubectl commands such as:
```bash
kubectl show pods --namespace=kube-system
kubectl get nodes
```

## Development

This repo uses https://github.com/cloudfoundry/bosh-deployment as git subtree. Run command ` git subtree pull --prefix bosh-deployment git@github.com:cloudfoundry/bosh-deployment.git <ref>` to update subtree.
