#!/bin/bash

set -o pipefail -e

[ -z "$DEBUG" ] || set -x

print_usage() {
  echo "Usage: $(basename "$0") [BOSH_ENV] [DEPLOYMENT_NAME]"
  echo ""
  echo "BOSH_ENV is the path to your BOSH environment configuration folder"
  echo ""
  echo "DEPLOYMENT_NAME is the name of your kubo deployment"
  echo ""
  echo "This script configures kubectl with your deployed kubo instance"
  echo "After running this command try: kubectl get pods --namespace=kube-system"
}

main() {
  local bosh_env deployment_name
  bosh_env=$(cd "${1}"; pwd -P)
  deployment_name="${2}"

  if [ $# -ne 2 ]; then
    print_usage
    exit  1
  fi

  if [ -z "$(bosh-cli int ${bosh_env}/director.yml --path /iaas)" ]; then
   echo "${bosh_env} is not a valid BOSH environment."
   echo "Please use 'generate_env_config' to create one."
   print_usage
   exit 1
  fi

  local script_location
  script_location=$(cd "$(dirname "${BASH_SOURCE[0]}")"; pwd)

  # shellcheck disable=SC1090
  source "$script_location/lib/deploy_utils"
  export_bosh_environment "${bosh_env}"

  local director_name credhub_user_password credhub_api_url tls_ca
  director_name=$(get_setting director.yml "/director_name")

  credhub_user_password="$(get_setting "creds.yml" "/credhub_user_password")"
  credhub_api_url="https://$(get_setting "director.yml" "/internal_ip"):8844"

  credhub login -u credhub-user -p "${credhub_user_password}" -s "${credhub_api_url}" --skip-tls-validation

  tmp_ca_file="$(mktemp)"
  tls_ca=$(credhub get -n "${director_name}/${deployment_name}/tls-kubernetes" --output-json)
  echo "$tls_ca" | bosh-cli int - --path=/ca > "${tmp_ca_file}"

  if [ "$(get_setting director.yml "/routing_mode")" = "cf" ]; then
    endpoint=$(get_setting director.yml "/cf-tcp-router-name")
    port=$(get_setting director.yml "/external-kubo-port")
  else
    endpoint="$(get_setting director.yml "/kubernetes_api_ip")"
    port=8443
  fi
  address="https://${endpoint}:${port}"
  admin_password=$(get_setting "${deployment_name}-creds.yml" "/kubo-admin-password")
  context_name="kubo-${deployment_name}"

  kubectl config set-cluster "${deployment_name}" --server="$address" --certificate-authority="${tmp_ca_file}" --embed-certs=true
  kubectl config set-credentials "${deployment_name}-admin" --token="${admin_password}"
  kubectl config set-context "${context_name}" --cluster="${deployment_name}" --user="${deployment_name}-admin"
  kubectl config use-context "${context_name}"

  echo "Created new kubectl context ${context_name}"
  echo "Try: kubectl get pods --namespace=kube-system"
}


[[ "$0" == "${BASH_SOURCE[0]}" ]] && main "$@"
